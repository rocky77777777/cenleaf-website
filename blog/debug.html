<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL解析デバッグ | CENLEAF</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .debug-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .error {
            background: #ffebee;
            color: #c62828;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
        }
        pre {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>URL解析デバッグツール</h1>
    
    <div class="debug-info">
        <h3>現在のURL情報</h3>
        <pre id="url-info"></pre>
    </div>
    
    <div class="debug-info">
        <h3>記事ID取得テスト</h3>
        <pre id="article-id-test"></pre>
    </div>
    
    <div class="debug-info">
        <h3>microCMS接続テスト</h3>
        <pre id="microcms-test"></pre>
    </div>
    
    <h3>テスト用リンク</h3>
    <ul>
        <li><a href="/blog/article.html?slug=llmo-ai-search-optimization">従来形式でLLMO記事</a></li>
        <li><a href="/blog/llmo-ai-search-optimization">新形式でLLMO記事</a></li>
        <li><a href="/blog/debug.html?slug=test-slug">デバッグページ（slugパラメータ付き）</a></li>
    </ul>

    <script>
        // article.htmlと同じ関数を複製
        function getArticleId() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            const slug = params.get('slug');
            
            // slugがある場合は、それを優先して返す
            if (slug) {
                return { type: 'slug', value: slug };
            }
            
            // IDがある場合
            if (id) {
                return { type: 'id', value: id };
            }
            
            // パスから記事スラッグを取得（/blog/slug形式に対応）
            const path = window.location.pathname;
            
            // /blog/article-slug 形式をチェック（拡張子なし）
            const pathMatch = path.match(/\/blog\/([^\/]+)$/);
            if (pathMatch && pathMatch[1] !== 'article' && pathMatch[1] !== 'index' && pathMatch[1] !== 'debug') {
                console.log('パスからスラッグを検出:', pathMatch[1]);
                return { type: 'slug', value: pathMatch[1] };
            }
            
            // 従来の /blog/article-id.html 形式もサポート
            const htmlMatch = path.match(/\/blog\/([^\/]+)\.html$/);
            if (htmlMatch && htmlMatch[1] !== 'article' && htmlMatch[1] !== 'debug') {
                return { type: 'slug', value: htmlMatch[1] };
            }
            
            return null;
        }

        // URL情報を表示
        function displayUrlInfo() {
            const info = {
                'フルURL': window.location.href,
                'パス': window.location.pathname,
                'クエリ': window.location.search,
                'ハッシュ': window.location.hash,
                'ホスト': window.location.host,
                'プロトコル': window.location.protocol
            };
            
            document.getElementById('url-info').textContent = JSON.stringify(info, null, 2);
        }

        // 記事ID取得テスト
        function testArticleId() {
            const result = getArticleId();
            const testResult = {
                '結果': result,
                'URLSearchParams取得': {
                    'id': new URLSearchParams(window.location.search).get('id'),
                    'slug': new URLSearchParams(window.location.search).get('slug')
                },
                'パス解析テスト': {
                    'パス': window.location.pathname,
                    'パターン1（/blog/[slug]$）': window.location.pathname.match(/\/blog\/([^\/]+)$/),
                    'パターン2（/blog/[slug].html$）': window.location.pathname.match(/\/blog\/([^\/]+)\.html$/)
                }
            };
            
            document.getElementById('article-id-test').textContent = JSON.stringify(testResult, null, 2);
        }

        // microCMS接続テスト
        async function testMicroCMS() {
            const testDiv = document.getElementById('microcms-test');
            testDiv.textContent = 'テスト中...';
            
            try {
                const SERVICE_ID = 'cenleaf';
                const ENDPOINT = 'blogs';
                const API_KEY = 'gfvzXw58nnvw3daLCbWS9z22SMKeIhxa1KWw';
                
                const response = await fetch(`https://${SERVICE_ID}.microcms.io/api/v1/${ENDPOINT}?limit=1`, {
                    headers: {
                        'X-MICROCMS-API-KEY': API_KEY
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    testDiv.className = 'debug-info success';
                    testDiv.innerHTML = '<h3>microCMS接続テスト - 成功</h3><pre>' + JSON.stringify(data, null, 2) + '</pre>';
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                testDiv.className = 'debug-info error';
                testDiv.innerHTML = '<h3>microCMS接続テスト - 失敗</h3><pre>' + error.message + '</pre>';
            }
        }

        // 実行
        displayUrlInfo();
        testArticleId();
        testMicroCMS();
    </script>
</body>
</html>