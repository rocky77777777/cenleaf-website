<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>おじさんスイカゲーム v2.1 - 改良版</title>
    
    <!-- PWA対応 -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none;
            overflow: hidden;
        }
        
        #gameContainer {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
        }
        
        .score {
            font-size: 24px;
            font-weight: bold;
        }
        
        .high-score {
            font-size: 14px;
            opacity: 0.9;
        }
        
        #gameCanvas {
            width: 100%;
            max-width: 400px;
            height: 600px;
            border: 4px solid #333;
            border-radius: 15px;
            background: #fafafa;
            cursor: pointer;
            display: block;
            margin: 0 auto;
        }
        
        .next-ojisan {
            margin-top: 15px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 10px;
            text-align: center;
        }
        
        .next-ojisan-preview {
            font-size: 40px;
            margin: 10px 0;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transition: all 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .game-over {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .game-over-content {
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: 20px;
            color: #333;
        }
        
        .game-over-title {
            font-size: 32px;
            margin-bottom: 20px;
            color: #ff3333;
        }
        
        .final-score {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
        }
        
        .combo-display {
            position: absolute;
            font-size: 24px;
            font-weight: bold;
            color: #ff6b6b;
            pointer-events: none;
            animation: comboAnimation 1s ease-out forwards;
        }
        
        @keyframes comboAnimation {
            0% {
                transform: scale(0.5) translateY(0);
                opacity: 1;
            }
            50% {
                transform: scale(1.5) translateY(-20px);
            }
            100% {
                transform: scale(1) translateY(-40px);
                opacity: 0;
            }
        }
        
        @media (max-width: 600px) {
            #gameContainer {
                border-radius: 0;
                height: 100vh;
                padding: 10px;
            }
            
            #gameCanvas {
                height: 500px;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div class="game-header">
            <div>
                <div class="score">スコア: <span id="score">0</span></div>
                <div class="high-score">最高: <span id="highScore">0</span></div>
            </div>
            <div id="comboText" style="display: none; color: #ffeb3b; font-size: 20px;">
                <span id="comboCount">0</span> コンボ! 🔥
            </div>
        </div>
        
        <canvas id="gameCanvas"></canvas>
        
        <div class="next-ojisan">
            <div style="font-size: 14px; color: #666;">次のおじさん</div>
            <div class="next-ojisan-preview" id="nextOjisan">👶</div>
        </div>
        
        <div class="controls">
            <button class="btn" onclick="resetGame()">🔄 リセット</button>
            <button class="btn btn-danger" onclick="shareScore()">📱 シェア</button>
        </div>
    </div>
    
    <div id="gameOver" class="game-over">
        <div class="game-over-content">
            <div class="game-over-title">ゲームオーバー！</div>
            <div class="final-score"><span id="finalScore">0</span>点</div>
            <button class="btn" onclick="resetGame()" style="width: 100%; margin-top: 20px;">
                もう一度プレイ
            </button>
        </div>
    </div>
    
    <script>
        // ゲーム設定
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 400;
        canvas.height = 600;
        
        // おじさんの種類
        const OJISAN_TYPES = [
            { emoji: '👶', size: 25, level: 1 },
            { emoji: '👦', size: 30, level: 2 },
            { emoji: '🧑', size: 35, level: 3 },
            { emoji: '👨', size: 40, level: 4 },
            { emoji: '🧔', size: 45, level: 5 },
            { emoji: '👨‍🦰', size: 50, level: 6 },
            { emoji: '👨‍🦱', size: 55, level: 7 },
            { emoji: '👨‍🦳', size: 60, level: 8 },
            { emoji: '👨‍🦲', size: 65, level: 9 },
            { emoji: '👴', size: 70, level: 10 },
            { emoji: '🎅', size: 80, level: 11 }
        ];
        
        // ゲーム状態
        let ojisans = [];
        let nextOjisanIndex = 0;
        let score = 0;
        let highScore = parseInt(localStorage.getItem('ojisanHighScore') || '0');
        let gameOver = false;
        let dropCooldown = false;
        let combo = 0;
        let lastMergeTime = 0;
        
        // 初期表示
        document.getElementById('highScore').textContent = highScore;
        
        // おじさんクラス
        class Ojisan {
            constructor(x, type) {
                this.x = x;
                this.y = 50;
                this.vx = 0;
                this.vy = 0;
                this.type = type;
                this.radius = type.size / 2;
                this.merged = false;
            }
            
            update() {
                // 重力
                this.vy += 0.5;
                
                // 速度制限
                this.vy = Math.min(this.vy, 15);
                
                // 位置更新
                this.x += this.vx;
                this.y += this.vy;
                
                // 壁との衝突
                if (this.x - this.radius < 20) {
                    this.x = 20 + this.radius;
                    this.vx *= -0.3;
                }
                if (this.x + this.radius > 380) {
                    this.x = 380 - this.radius;
                    this.vx *= -0.3;
                }
                
                // 床との衝突
                if (this.y + this.radius > 580) {
                    this.y = 580 - this.radius;
                    this.vy *= -0.5;
                    this.vx *= 0.9; // 摩擦
                }
                
                // 他のおじさんとの衝突
                ojisans.forEach(other => {
                    if (other !== this && !this.merged && !other.merged) {
                        const dx = this.x - other.x;
                        const dy = this.y - other.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        const minDistance = this.radius + other.radius;
                        
                        if (distance < minDistance) {
                            // 同じレベルなら合体
                            if (this.type.level === other.type.level && this.type.level < 11) {
                                this.merge(other);
                            } else {
                                // 衝突処理
                                const overlap = minDistance - distance;
                                const separationX = (dx / distance) * overlap * 0.5;
                                const separationY = (dy / distance) * overlap * 0.5;
                                
                                this.x += separationX;
                                this.y += separationY;
                                other.x -= separationX;
                                other.y -= separationY;
                                
                                // 速度交換
                                const tempVx = this.vx;
                                const tempVy = this.vy;
                                this.vx = other.vx * 0.8;
                                this.vy = other.vy * 0.8;
                                other.vx = tempVx * 0.8;
                                other.vy = tempVy * 0.8;
                            }
                        }
                    }
                });
            }
            
            merge(other) {
                if (this.merged || other.merged) return;
                
                this.merged = true;
                other.merged = true;
                
                // 新しいおじさんを作成
                const newType = OJISAN_TYPES[this.type.level];
                const newOjisan = new Ojisan(
                    (this.x + other.x) / 2,
                    newType
                );
                newOjisan.y = (this.y + other.y) / 2;
                
                // スコア計算
                const points = newType.level * 100;
                score += points;
                updateScore();
                
                // コンボ判定
                const now = Date.now();
                if (now - lastMergeTime < 2000) {
                    combo++;
                    showCombo();
                } else {
                    combo = 1;
                }
                lastMergeTime = now;
                
                // エフェクト表示
                showMergeEffect(newOjisan.x, newOjisan.y, points);
                
                // 配列を更新
                setTimeout(() => {
                    ojisans = ojisans.filter(o => o !== this && o !== other);
                    ojisans.push(newOjisan);
                }, 0);
            }
            
            draw() {
                ctx.font = `${this.type.size}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(this.type.emoji, this.x, this.y);
            }
        }
        
        // おじさんを落とす
        function dropOjisan(x) {
            if (gameOver || dropCooldown) return;
            
            const type = OJISAN_TYPES[nextOjisanIndex];
            const ojisan = new Ojisan(x, type);
            ojisans.push(ojisan);
            
            // 次のおじさんをランダムに選択（レベル1-5）
            nextOjisanIndex = Math.floor(Math.random() * 5);
            document.getElementById('nextOjisan').textContent = OJISAN_TYPES[nextOjisanIndex].emoji;
            
            // クールダウン
            dropCooldown = true;
            setTimeout(() => {
                dropCooldown = false;
            }, 500);
            
            // ゲームオーバーチェック
            checkGameOver();
        }
        
        // ゲームオーバーチェック
        function checkGameOver() {
            const hasHighOjisan = ojisans.some(o => o.y < 100 && o.vy < 1);
            if (hasHighOjisan) {
                gameOver = true;
                document.getElementById('finalScore').textContent = score;
                document.getElementById('gameOver').style.display = 'flex';
                
                if (score > highScore) {
                    highScore = score;
                    localStorage.setItem('ojisanHighScore', highScore);
                    document.getElementById('highScore').textContent = highScore;
                }
            }
        }
        
        // スコア更新
        function updateScore() {
            document.getElementById('score').textContent = score;
        }
        
        // コンボ表示
        function showCombo() {
            if (combo > 1) {
                document.getElementById('comboCount').textContent = combo;
                document.getElementById('comboText').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('comboText').style.display = 'none';
                }, 2000);
            }
        }
        
        // 合体エフェクト
        function showMergeEffect(x, y, points) {
            const effect = document.createElement('div');
            effect.className = 'combo-display';
            effect.textContent = `+${points}`;
            effect.style.left = `${x + canvas.offsetLeft}px`;
            effect.style.top = `${y + canvas.offsetTop}px`;
            document.body.appendChild(effect);
            
            setTimeout(() => {
                effect.remove();
            }, 1000);
        }
        
        // ゲームリセット
        function resetGame() {
            ojisans = [];
            score = 0;
            combo = 0;
            gameOver = false;
            nextOjisanIndex = 0;
            updateScore();
            document.getElementById('nextOjisan').textContent = OJISAN_TYPES[0].emoji;
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('comboText').style.display = 'none';
        }
        
        // スコアシェア
        function shareScore() {
            const text = `おじさんスイカゲームで${score}点を獲得しました！🎮\nhttps://cenleaf.com/game/ojisan-suika-fixed.html`;
            if (navigator.share) {
                navigator.share({
                    title: 'おじさんスイカゲーム',
                    text: text
                });
            } else {
                window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`, '_blank');
            }
        }
        
        // ゲームループ
        function gameLoop() {
            // キャンバスクリア
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 背景
            ctx.fillStyle = '#fafafa';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 壁を描画
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(20, 0);
            ctx.lineTo(20, 580);
            ctx.lineTo(380, 580);
            ctx.lineTo(380, 0);
            ctx.stroke();
            
            // 危険ライン
            ctx.strokeStyle = 'rgba(255, 0, 0, 0.3)';
            ctx.lineWidth = 2;
            ctx.setLineDash([10, 5]);
            ctx.beginPath();
            ctx.moveTo(20, 100);
            ctx.lineTo(380, 100);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // おじさんを更新・描画
            if (!gameOver) {
                ojisans.forEach(ojisan => ojisan.update());
            }
            ojisans.forEach(ojisan => ojisan.draw());
            
            requestAnimationFrame(gameLoop);
        }
        
        // イベントリスナー
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const canvasX = (x / rect.width) * canvas.width;
            dropOjisan(canvasX);
        });
        
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            const x = touch.clientX - rect.left;
            const canvasX = (x / rect.width) * canvas.width;
            dropOjisan(canvasX);
        });
        
        // ゲーム開始
        gameLoop();
    </script>
</body>
</html>